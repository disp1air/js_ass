### Работа с протоколом HTTP
Термин Ajax описывает архитектуру веб-приложений, отличительной чертой которых является работа с протоколом HTTP. Ключевой особенностью Ajax-приложения является использование протокола HTTP для инициации обмена данными с веб-сервером без необходимости перезагружать страницу.

Термин Comet описывает похожую архитектуру веб-приложений, также использующих протокол HTTP. В некотором смысле
архитектура Comet является обратной по отношению к Ajax: в архитектуре Comet не клиент, а сервер инициирует
взаимодействие, асинхронно отсылая сообщения клиенту.

В архитектуре Ajax клиент «вытягивает» данные с сервера. В архитектуре Comet сервер «навязывает» данные клиенту.

Даже изменение свойства src элемента <script> может использоваться для инициирования HTTP-запроса GET. Использование
элементов <script> для работы с протоколом HTTP выглядит особенно привлекательно, потому что они не являются субъектами политики общего происхождения и могут использоваться для взаимодействий с разными серверами.

### Использование объекта XMLHttpRequest
Прикладной интерфейс к протоколу HTTP в броузерах определяется в виде класса XMLHttpRequest. Объект XMLHttpRequest не является прикладным интерфейсом уровня протокола, он обеспечивает прикладной интерфейс уровня броузера. Броузер сам заботится о cookies, переадресации, кэшировании и прокси-серверах, а вам достаточно позаботиться только о запросах и ответах.  Каждый экземпляр этого класса представляет единственную пару запрос/ответ, а свойства и методы объекта позволяют определять параметры запроса и извлекать данные из ответа.

HTTP-запрос состоит из четырех частей:
  • метод HTTP-запроса или тип «операции»
  • запрашиваемый URL-адрес
  • необязательные заголовки запроса, которые могут включать информацию для аутентификации
  • необязательное тело запроса

                                var request = new XMLHttpRequest();
                                request.open(
                                    "GET", // Запрос типа HTTP GET 
                                    "data.csv" // на получение содержимого по этому URL-адресу
                                );
                                request.setRequestHeader("Content-Type", "text/plain"); // установка заголовка
                                request.send(null); // передача тела запроса

HTTP-ответ, возвращаемый сервером, состоит из трех частей:
  • числовое и текстовое значение, определяющее код состояния, свидетельствующий об успехе или об ошибке
  • набор заголовков ответа
  • тело ответа

Чтобы определить момент получения ответа, необходимо обрабатывать событие «readystatechange» (или событие «progress»,
определяемое новой спецификацией «XHR2»), возбуждаемое в объекте XMLHttpRequest.

Свойство readyState – это целочисленное значение, определяющее код состояния HTTP-запроса;

                               Константа          Значение                   Смысл
                                UNSENT                0          Метод open() еще не был вызван
                                OPENED                1              Метод open() был вызван
                            HEADERS_RECEIVED          2              Были получены заголовки
                                LOADING               3              Идет прием тела ответа
                                 DONE                 4              Прием ответа завершен

Чтобы обрабатывать события «readystatechange», нужно присвоить функцию обработчика события свойству onreadystatechange объекта XMLHttpRequest.

overrideMimeType() - с его помощью можно определить MIME-тип ответа сервера, лучше подходящий для веб-приложения,
чем возвращаемый сервером.

### События, возникающие в ходе выполнения HTTP-запроса
Раньше для определения момента завершения HTTP-запроса использовалось событие «readystatechange». Проект спецификации
«XHR2» определяет более удобный набор событий. В этой новой модели событий объект XMLHttpRequest генерирует различные
типы событий на разных этапах выполнения запроса, благодаря чему отпадает необходимость проверять значение свойства
readyState.

Когда вызывается метод send(), один раз возбуждается событие «loadstart». В ходе загрузки ответа сервера объект
XMLHttpRequest возбуждает серию событий «progress», обычно каждые 50 миллисекунд или около того, которые можно
использовать для обратной связи с пользователем, чтобы информировать его о ходе выполнения запроса. Если запрос
завершается очень быстро, событие «progress» может и не возбуждаться. По завершении запроса возбуждается событие
«load».

Существуют три разные ситуации, когда HTTP-запрос оканчивается неудачей, которым соответствуют три события:
 * Если предельное время ожидания ответа истекло, генерируется событие «timeout».
 * Если выполнение запроса было прервано, генерируется событие «abort».
 * Если выполнению запроса могут препятствовать другие ошибки в сети, генерируется событие «error».

                                        var oReq = new XMLHttpRequest();

                                        oReq.addEventListener("progress", updateProgress, false);
                                        oReq.addEventListener("load", transferComplete, false);
                                        oReq.addEventListener("error", transferFailed, false);
                                        oReq.addEventListener("abort", transferCanceled, false);

                                        oReq.open();

Определяя наличие этих свойств, можно даже проверить поддержку соответствующих событий в броузере:

                                        if ("onprogress" in (new XMLHttpRequest())) {
                                            // События, возникающие в ходе выполнения
                                            // запроса, поддерживаются
                                        }

Объект события, связанный с этими событиями, возникающими в ходе выполнения запроса, в дополнение к свойствам
обычного объекта Event, добавляет три полезных свойства:
 * loaded - определяет количество байтов, переданных к моменту возбуждения события.
 * total - содержит общий объем (в байтах) загружаемых данных.
 * lengthComputable - содержит значение true, если общий объем содержимого известен, и false – в противном случае.

                                        request.onprogress = function(event) {
                                            if (e.lengthComputable) {
                                                var res = 100 * event.loaded / event.total;
                                                progress.innerHTML = Math.round(res) + "% Выполнено";
                                            }
                                        }

### Прерывание запросов и предельное время ожидания
Выполнение HTTP-запроса можно прерывать вызовом метода abort() объекта XMLHttpRequest, вызов метода abort() генерирует
событие «abort».

Основная причина для вызова метода abort() – появление необходимости отменить запрос, превышение предельного времени
ожидания или если ответ становится ненужным. Допустим, что объект XMLHttpRequest используется для запроса подсказки
в механизме автодополнения для текстового поля ввода. Если пользователь успеет ввести в поле новый символ еще до того,
как подсказка будет получена с сервера, надобность в этой подсказке отпадает и запрос можно прервать.

Спецификация «XHR2» определяет свойство timeout, в котором указывается промежуток времени в миллисекундах, после
которого запрос автоматически будет прерван, а также определяет событие «timeout», которое должно генерироваться
(вместо события «abort») по истечении установленного промежутка времени.

### Выполнение HTTP-запросов с помощью <script>: JSONP
Элемент <script> можно использовать в качестве Ajax-транспорта: если создать тег <script src>, то при добавлении в документ, броузер сгенерирует HTTP-запрос, чтобы загрузить содержимое ресурса по указанному URL-адресу. В ответ сервер может прислать скрипт, содержащий нужные данные.

                                                function addScript(src) {
                                                    var elem = document.createElement("script");
                                                    elem.src = src;
                                                    document.head.appendChild(elem);
                                                }

                                                addScript('user?id=123');

Основная причина, почему элементы <script> являются удобным Ajax-транспортом, состоит в том, что они не являются
субъектами политики общего происхождения и их можно использовать для запроса данных с других серверов. Вторая причина
состоит в том, что элементы <script> автоматически декодируют (т. е. выполняют) тело ответа, содержащего данные в формате JSON. в теле ответа на HTTP-запрос возвращаются данные в формате JSON. Символ «P» означает «padding», или «prefix».